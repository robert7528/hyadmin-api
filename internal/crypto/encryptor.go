// Package crypto provides Tink-backed AES-GCM encryption for PII fields.
package crypto

import (
	"encoding/base64"
	"fmt"
	"strings"

	"github.com/tink-crypto/tink-go/v2/aead"
	"github.com/tink-crypto/tink-go/v2/insecurecleartextkeyset"
	"github.com/tink-crypto/tink-go/v2/keyset"
	tinkaead "github.com/tink-crypto/tink-go/v2/tink"
)

// Encryptor encrypts and decrypts string values.
type Encryptor interface {
	Encrypt(plaintext string) (string, error)
	Decrypt(ciphertext string) (string, error)
}

// tinkEncryptor uses a Tink AEAD primitive.
type tinkEncryptor struct {
	primitive tinkaead.AEAD
}

// NewTinkEncryptor loads a cleartext JSON keyset and returns an Encryptor.
// keysetJSON must be a valid Tink JSON keyset (e.g. generated by tinkey).
func NewTinkEncryptor(keysetJSON string) (Encryptor, error) {
	r := keyset.NewJSONReader(strings.NewReader(keysetJSON))
	kh, err := insecurecleartextkeyset.Read(r)
	if err != nil {
		return nil, fmt.Errorf("crypto: read keyset: %w", err)
	}
	a, err := aead.New(kh)
	if err != nil {
		return nil, fmt.Errorf("crypto: create AEAD: %w", err)
	}
	return &tinkEncryptor{primitive: a}, nil
}

func (e *tinkEncryptor) Encrypt(plaintext string) (string, error) {
	if plaintext == "" {
		return "", nil
	}
	ct, err := e.primitive.Encrypt([]byte(plaintext), nil)
	if err != nil {
		return "", fmt.Errorf("crypto: encrypt: %w", err)
	}
	return base64.StdEncoding.EncodeToString(ct), nil
}

func (e *tinkEncryptor) Decrypt(ciphertext string) (string, error) {
	if ciphertext == "" {
		return "", nil
	}
	ct, err := base64.StdEncoding.DecodeString(ciphertext)
	if err != nil {
		return "", fmt.Errorf("crypto: decode base64: %w", err)
	}
	pt, err := e.primitive.Decrypt(ct, nil)
	if err != nil {
		return "", fmt.Errorf("crypto: decrypt: %w", err)
	}
	return string(pt), nil
}

// nopEncryptor stores plaintext as-is; used when no keyset is configured (dev mode).
type nopEncryptor struct{}

// NewNopEncryptor returns an Encryptor that does not encrypt (dev/test only).
func NewNopEncryptor() Encryptor { return &nopEncryptor{} }

func (n *nopEncryptor) Encrypt(plaintext string) (string, error) { return plaintext, nil }
func (n *nopEncryptor) Decrypt(ciphertext string) (string, error) { return ciphertext, nil }

// New returns a Tink encryptor when keysetJSON is provided, otherwise NOP.
func New(keysetJSON string) (Encryptor, error) {
	if keysetJSON == "" {
		return NewNopEncryptor(), nil
	}
	return NewTinkEncryptor(keysetJSON)
}
